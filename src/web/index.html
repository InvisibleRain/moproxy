<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MoProxy</title>
  <style>
    body { margin: 1em 3em; color: #555; }
    table { border-collapse: collapse; }
    tbody { color: black; }
    h1, h2 { color: darkslategray; }
    th, td { border-bottom: 1px solid #ddd; }
    td { line-height: 1.5; font-size: 1.2em; padding: 0 0.8em; }
    th { line-height: 2; }
    tr.offline { background: lightpink; }
    #servers { font-family: "Courier New", Courier, monospace; }
    #servers tr:hover { background-color: #eee; }
    #servers td:nth-last-child(-n+2) { text-align: right; }
  </style>
</head>
<body>
  <h1>MoProxy</h1>
  <p>MoProxy is running.</p>
  <button id="refresh">Refresh</button>

  <h2>Proxy servers</h2>
  <table>
    <thead>
      <tr><th>Tag<th>Protocol<th>Address<th>Score<th>Lastest delay</tr>
    </thead>
    <tbody id="servers"></tbody>
  </table>

  <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script>
    const API_SERVERS = "servers";
    $(document).ready(update);

    function update() {
      let $table = $('#servers').empty();
      $.getJSON(API_SERVERS).done(function (servers) {
        for (let server of servers) {
          $table.append(newServerRow(server));
        }
      });
    }

    function newServerRow(info) {
      let $row = $(
          `<tr><td>${info.server.tag}
          <td>${info.server.proto}
          <td>${info.server.addr}
          <td>${info.score || '-'}
          <td>${durationToMills(info.delay) || '-'}</tr>`);
      if (info.delay == null)
        $row.addClass('offline');
      return $row;
    }

    function durationToMills(t) {
      if (t == null) return null;
      let ms = Math.round(t.secs * 1000 + t.nanos / 1e6);
      if (ms < 1000)
        return `${ms} ms`;
      else
        return `${Math.floor(ms / 1000)},${ms % 1000} ms`;
    }

    $('#refresh').click(update);
  </script>
</body>
</html>
