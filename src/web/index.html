<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>moproxy</title>
  <style>
    body { margin: 1em 3em; color: #555; }
    table { border-collapse: collapse; }
    tbody { color: black; }
    h1, h2 { color: darkslategray; }
    th, td { border-bottom: 1px solid #ddd; }
    td { line-height: 1.5; font-size: 1.2em; padding: 0 0.8em; }
    th { line-height: 2; padding: 0 0.8em; }
    tr.offline { background: lightpink; }
    #servers { font-family: "Courier New", Courier, monospace; }
    #servers tr:hover { background-color: #eee; }
    #servers td:nth-child(n+2) { text-align: right; }
    thead th:nth-child(n+2) { text-align: right; }
  </style>
</head>
<body>
  <h1>moproxy</h1>
  <p>moproxy <span id="version"></span> is running.</p>
  <button id="refresh">Refresh</button>
  <input id="auto-refresh" type="checkbox">
  <label for="auto-refresh">auto</label>

  <h2>Proxy servers</h2>
  <table>
    <thead>
      <tr><th>Server<th>Score<th>Delay</th>
        <th>CUR / TTL<th>Up / Down</tr>
    </thead>
    <tbody id="servers"></tbody>
  </table>

  <script>
    const API_SERVERS = "servers";
    const API_VERSION = "version";
    const REFRESH_MILLS = 2 * 1000;
    let $ = s => document.querySelector(s);

    let timeoutId = 0;
    async function update() {
      let table = $('#servers');
      let button = $('#refresh');
      let refresh = $('#auto-refresh');
      if (button.disabled) return;
      button.disabled = true;
      try {
        let resp = await fetch(API_SERVERS);
        if (!resp.ok)
          throw new Error(`server return ${resp.status}`);
        let servers = await resp.json();
        table.innerHTML = '';
        servers.forEach(server => {
          table.appendChild(newServerRow(server));
        });
      } catch (ex) {
        alert(`Fail to refresh: ${ex.message}`);
        refresh.checked = false;
      } finally {
        button.disabled = false;
      }
      if (refresh.checked && !document.hidden) {
        window.clearTimeout(timeoutId);
        timeoutId = window.setTimeout(update, REFRESH_MILLS);
      }
    }

    function newServerRow(server, range) {
      let row = document.createElement('tr');
      row.innerHTML = `<tr>
         <td><span title="${server.proto}://${server.addr}"
             >${server.tag}</span></td>
         <td><span title="based on average delay"
             >${server.score || '-'}</span></td>
         <td><span title="TCP handshake included"
             >${durationToMills(server.delay) || '-'}</span></td>
         <td><span title="# current connections"
             >${numberWithCommas(server.conn_alive)}</span> /
             <span title="# total connections"
             >${numberWithCommas(server.conn_total)}</span></td>
         <td><span title="total sent"
             >${humanFileSize(server.tx_bytes)}</span> /
             <span title="total received"
             >${humanFileSize(server.rx_bytes)}</span></td>
         </tr>`;
      if (server.delay == null)
        row.className = 'offline';
      return row;
    }

    function durationToMills(t) {
      if (t == null) return null;
      let ms = Math.round(t.secs * 1000 + t.nanos / 1e6);
      return `${numberWithCommas(ms)} ms`;
    }

    // https://stackoverflow.com/a/2901298/1833236
    const numberWithCommas = (x) => {
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }

    // https://stackoverflow.com/a/20732091/1833236
    function humanFileSize(size) {
      if (size == 0) return 0;
      var i = Math.floor(Math.log(size) / Math.log(1024));
      return (size / Math.pow(1024, i)).toFixed(2) * 1 + ' '
        + ['B', 'KiB', 'MiB', 'GiB', 'TiB'][i];
    };

    $('#refresh').addEventListener('click', update);
    $('#auto-refresh').addEventListener('change', function () {
      if (this.checked) update();
    });
    document.addEventListener('visibilitychange', function () {
      if ($('#auto-refresh').checked && !document.hidden) update();
    });

    (async function () {
      let resp = await fetch(API_VERSION);
      if (resp.ok) {
        let ver = await resp.text();
        $('#version').textContent = `(v${ver})`;
      }
      await update();
    })();
  </script>
</body>
</html>
